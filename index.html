/******************************************************
 * ä»£æ›¿èŠ±ç”³è«‹ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - Gmail â‡„ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº
 * 
 * æ©Ÿèƒ½æ¦‚è¦ï¼š
 *  â‘  Gmailå—ä¿¡ â†’ ã‚¹ãƒ—ã‚·ç™»éŒ²ï¼ˆæ·»ä»˜ä¿å­˜ï¼‰
 *  â‘¡ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ â†’ Gmailãƒ©ãƒ™ãƒ«æ›´æ–°
 *  â‘¢ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ â†’ è‡ªå‹•ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬å·®ã—è¾¼ã¿ï¼‰
 ******************************************************/

const SHEET_MAIN = "é€²æ—ä¸€è¦§";
const SHEET_MAIL = "ãƒ¡ãƒ¼ãƒ«è¨­å®š";
const DRIVE_FOLDER_ID = "1Hl_f7FE8cg6iRbycyfAFzb0ryXZjdvRJ";
const MAIN_LABEL = "ä»£æ›¿èŠ±ç”³è«‹";
const SPREADSHEET_ID = '1DMH4w1eA_CxSYCVhCjJyewweuMat2xsR3LRVp1doFNY';

/**
 * Gmailå—ä¿¡ â†’ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç™»éŒ²
 */
function processDefectMails() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_MAIN);
  const threads = GmailApp.search('subject:ä»£æ›¿èŠ±ç”³è«‹');
  const baseLabel = getOrCreateLabel(MAIN_LABEL);
  const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);

  Logger.log(`ğŸ” å¯¾è±¡ã‚¹ãƒ¬ãƒƒãƒ‰æ•°: ${threads.length}`);

  threads.forEach(thread => {
    const messages = thread.getMessages();
    const msg = messages[messages.length - 1];
    const subject = msg.getSubject();
    const body = msg.getPlainBody();
    const from = msg.getFrom();
    const dateObj = msg.getDate();
    const dateStr = Utilities.formatDate(dateObj, Session.getScriptTimeZone(), 'yyyy/MM/dd HH:mm');
    const dateForName = Utilities.formatDate(dateObj, Session.getScriptTimeZone(), 'yyMMdd');

    Logger.log(`ğŸ“§ å‡¦ç†ä¸­: ${subject} from=${from}`);

    // --- æœ¬æ–‡æŠ½å‡º ---
    const applicant = getValue(body, "â– ç”³è«‹è€…åï¼š");
    const vendor = getValue(body, "â– å–å¼•å…ˆåï¼š");
    const orderNo = String(getValue(body, "â– å—æ³¨ç•ªå·ï¼š")).trim();
    const defect = getValue(body, "â– ä¸è‰¯ã®çŠ¶æ³ï¼š");
    const note = getValue(body, "â– ç”³ã—é€ã‚Šäº‹é …ï¼š");

    if (!orderNo) {
      Logger.log(`âš  å—æ³¨ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
      return;
    }

    // --- ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèª ---
    let data = [];
    let orderNos = [];
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      data = sheet.getRange(2, 1, lastRow - 1, 13).getValues();
      orderNos = data.map(r => String(r[3]).trim());
    }

    if (orderNos.includes(orderNo)) {
      Logger.log(`â© ${orderNo} ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã€‚ã‚¹ã‚­ãƒƒãƒ—`);
      thread.addLabel(baseLabel);
      thread.moveToArchive();
      return;
    }

    // --- æ·»ä»˜ä¿å­˜ ---
    const attachments = msg.getAttachments({ includeInlineImages: false });
    const fileUrls = [];
    attachments.forEach((file, i) => {
      const fileName = `${orderNo}_${vendor}_${dateForName}_${i + 1}`;
      const blob = file.copyBlob().setName(fileName);
      const saved = folder.createFile(blob);
      fileUrls.push(saved.getUrl());
    });

    // --- ç©ºç™½è¡Œã‚’æ¢ç´¢ ---
    let insertRow = lastRow + 1;
    const allValues = sheet.getDataRange().getValues();
    for (let i = 1; i < allValues.length; i++) {
      if (allValues[i].every(cell => cell === "")) {
        insertRow = i + 1;
        break;
      }
    }

    // --- æ–°è¦è¡Œç™»éŒ² ---
    const newRow = [
      "æœªå¯¾å¿œ", dateStr, applicant, orderNo, vendor,
      defect, note,
      fileUrls[0] || "", fileUrls[1] || "", fileUrls[2] || "", fileUrls[3] || "", fileUrls[4] || "",
      from
    ];
    sheet.getRange(insertRow, 1, 1, newRow.length).setValues([newRow]);
    Logger.log(`âœ… æ–°è¦è¿½åŠ : ${orderNo}ï¼ˆç”³è«‹è€…: ${applicant}ï¼‰`);

    // --- Gmailãƒ©ãƒ™ãƒ«å‡¦ç† ---
    const statusLabel = getOrCreateLabel(`${MAIN_LABEL}/æœªå¯¾å¿œ`);
    thread.addLabel(baseLabel);
    thread.addLabel(statusLabel);
    thread.moveToArchive();
  });

  Logger.log("ğŸ‰ å…¨ã‚¹ãƒ¬ãƒƒãƒ‰å‡¦ç†å®Œäº†");
}

/**
 * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ¤œçŸ¥ï¼ˆonEditï¼‰
 */
function onEdit(e) {
  const sheet = e.source.getActiveSheet();
  if (sheet.getName() !== SHEET_MAIN) return;
  const row = e.range.getRow();
  const col = e.range.getColumn();
  if (col !== 1 || row === 1) return;

  const status = e.value;
  const from = sheet.getRange(row, 13).getValue();
  if (!from) return;

  updateGmailLabel(from, status);
  sendStatusMail(row, status);
}

/**
 * Gmailãƒ©ãƒ™ãƒ«æ›´æ–°
 */
function updateGmailLabel(from, status) {
  const threads = GmailApp.search(`from:${from} subject:ä»£æ›¿èŠ±ç”³è«‹`);
  const baseLabel = getOrCreateLabel(MAIN_LABEL);
  const newLabel = getOrCreateLabel(`${MAIN_LABEL}/${status}`);

  threads.forEach(thread => {
    thread.getLabels().forEach(label => {
      if (label.getName().startsWith(`${MAIN_LABEL}/`)) {
        thread.removeLabel(label);
      }
    });
    thread.addLabel(baseLabel);
    thread.addLabel(newLabel);
  });
}

/**
 * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ é€šçŸ¥ãƒ¡ãƒ¼ãƒ«
 */
function sendStatusMail(row, status) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_MAIN);
  const mailSheet = ss.getSheetByName(SHEET_MAIL);

  const subjectTemplate = mailSheet.getRange("A8").getValue();
  const bodyTemplate = mailSheet.getRange("A11").getValue();
  const senders = mailSheet.getRange("B2:B6").getValues().flat().filter(Boolean);

  const values = sheet.getRange(row, 1, 1, 13).getValues()[0];
  const headers = sheet.getRange(1, 1, 1, 13).getValues()[0];
  const recipient = values[12];

  // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æ•´ãˆã‚‹
  const formattedValues = [...values];
  const dateIndex = headers.indexOf("ç”³è«‹æ—¥");
  if (dateIndex !== -1 && values[dateIndex]) {
    const rawDate = new Date(values[dateIndex]);
    formattedValues[dateIndex] = Utilities.formatDate(rawDate, Session.getScriptTimeZone(), "yyyy/MM/dd HH:mm");
  }

  // å·®ã—è¾¼ã¿ç½®æ›
  let subject = subjectTemplate;
  let body = bodyTemplate;
  headers.forEach((h, i) => {
    const key = `{{${h}}}`;
    const val = formattedValues[i] || "";
    subject = subject.replaceAll(key, val);
    body = body.replaceAll(key, val);
  });

  const sender = senders[Math.floor(Math.random() * senders.length)];
  GmailApp.sendEmail(recipient, subject, body, {
    name: "ä»£æ›¿èŠ±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ",
    from: sender
  });

  Logger.log(`ğŸ“¤ é€šçŸ¥é€ä¿¡å®Œäº†: ${recipient}ï¼ˆ${status}ï¼‰`);
}

/**
 * æœ¬æ–‡æŠ½å‡º
 */
function getValue(body, key) {
  const regex = new RegExp(`${key}(.*)`);
  const match = body.match(regex);
  return match ? match[1].trim() : "";
}

/**
 * Gmailãƒ©ãƒ™ãƒ«å–å¾—/ä½œæˆ
 */
function getOrCreateLabel(name) {
  const label = GmailApp.getUserLabelByName(name);
  return label || GmailApp.createLabel(name);
}
